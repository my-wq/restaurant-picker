<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>éšæœºé€‰é¥­åº—å·¥å…· - æ™ºèƒ½é¤å…æ¨èåŠ©æ‰‹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="æ™ºèƒ½éšæœºé€‰é¥­åº—å·¥å…·ï¼Œæ”¯æŒåœ°å›¾å®šä½ã€èŒƒå›´æœç´¢ã€åˆ†ç±»ç­›é€‰ï¼Œå¸®æ‚¨å¿«é€Ÿæ‰¾åˆ°é™„è¿‘çš„ä¼˜è´¨é¤å…ã€‚å‘Šåˆ«é€‰æ‹©å›°éš¾ç—‡ï¼">
    <meta name="keywords" content="é€‰é¥­åº—,é¤å…æ¨è,éšæœºæ¨è,åœ°å›¾æœç´¢,ç¾é£Ÿ,é™„è¿‘é¤å…">
    <meta name="author" content="ç„å¢¨çƒ¬é›ª">
    
    <!-- Open Graph Meta Tags for social sharing -->
    <meta property="og:title" content="éšæœºé€‰é¥­åº—å·¥å…· - æ™ºèƒ½é¤å…æ¨èåŠ©æ‰‹">
    <meta property="og:description" content="æ™ºèƒ½éšæœºé€‰é¥­åº—å·¥å…·ï¼Œæ”¯æŒåœ°å›¾å®šä½ã€èŒƒå›´æœç´¢ã€åˆ†ç±»ç­›é€‰ï¼Œå¸®æ‚¨å¿«é€Ÿæ‰¾åˆ°é™„è¿‘çš„ä¼˜è´¨é¤å…ã€‚å‘Šåˆ«é€‰æ‹©å›°éš¾ç—‡ï¼">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://xuanmojinxue.com">
    <meta property="og:site_name" content="ç„å¢¨é‡‘å­¦">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzAwNzhkNCIvPgo8dGV4dCB4PSIxNiIgeT0iMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7ppoE8L3RleHQ+Cjwvc3ZnPgo=">
    
    <style>
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: #f7f7f7; margin: 0; }
        .container { max-width: 500px; margin: 40px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #ccc; padding: 24px; }
        h2 { text-align: center; color: #333; }
        .btn { display: block; margin: 20px auto 0; padding: 10px 24px; background: #0078d4; color: #fff; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
        .btn:hover { background: #005fa3; }
        .restaurant-list { margin-top: 24px; }
        .restaurant { background: #f2f6fa; border-radius: 8px; margin-bottom: 16px; padding: 16px; box-shadow: 0 1px 4px #e0e0e0; }
        .restaurant-title { font-size: 18px; font-weight: bold; color: #0078d4; }
        .restaurant-info { font-size: 14px; color: #555; margin-top: 6px; }
        #pagination { text-align: center; margin: 12px 0; }
        #pagination button { margin: 0 8px; padding: 6px 16px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>éšæœºé€‰é¥­åº—å·¥å…·</h2>
        <!-- åœ°å€è¾“å…¥åŒº -->
        <div style="margin-bottom:12px;text-align:center;">
            <label for="addressInput">åœ°å€/åœ°æ ‡ï¼š</label>
            <input type="text" id="addressInput" placeholder="è¾“å…¥åœ°å€/åœ°æ ‡/åæ ‡" style="width:220px;padding:6px;border-radius:6px;border:1px solid #ccc;">
            <div id="addressSuggest" style="background:#fff;border:1px solid #ccc;border-radius:6px;max-height:120px;overflow-y:auto;position:absolute;z-index:10;width:220px;display:none;"></div>
        </div>
        <!-- èŒƒå›´è¾“å…¥åŒº -->
        <div style="margin-bottom:12px;text-align:center;">
            <label for="radiusInput">æœç´¢èŒƒå›´ï¼š</label>
            <input type="text" id="radiusInput" value="2å…¬é‡Œ" style="width:80px;padding:6px;border-radius:6px;border:1px solid #ccc;">
            <span id="radiusTip" style="color:#888;font-size:13px;margin-left:8px;"></span>
        </div>
        <!-- åœ°å›¾é€‰å€åŒº -->
        <div id="map" style="width:100%;height:300px;margin-bottom:16px;border-radius:8px;"></div>
        <div style="text-align:center;margin-bottom:8px;">
            <button class="btn" id="refreshBtn">é‡æ–°é€‰æ‹©</button>
            <button class="btn" id="randomBtn" style="background:#28a745;margin-left:12px;">éšæœºæ¨è</button>
            <button class="btn" id="satelliteBtn" style="background:#aaa;margin-left:12px;">åˆ‡æ¢å«æ˜Ÿ/æ ‡å‡†</button>
        </div>
        <div id="status" style="text-align:center;color:#888;margin-top:10px;"></div>
        <!-- åˆ†ç±»ç­›é€‰åŒº -->
        <div id="categoryFilter" style="text-align:center;margin-bottom:8px;"></div>
        <div class="restaurant-list" id="restaurantList"></div>
        
        <!-- é¡µè„šä¿¡æ¯ -->
        <div style="text-align:center;margin-top:40px;padding-top:20px;border-top:1px solid #eee;color:#999;font-size:12px;">
            <p>Â© 2025 <a href="https://xuanmojinxue.com" style="color:#0078d4;text-decoration:none;">ç„å¢¨é‡‘å­¦</a> | æ™ºèƒ½é¤å…æ¨èå·¥å…·</p>
            <p>æ•°æ®æ¥æºï¼šé«˜å¾·åœ°å›¾API | ä»…ä¾›å‚è€ƒï¼Œè¯·ä»¥å®é™…æƒ…å†µä¸ºå‡†</p>
            <p style="margin-top:10px;">
                <span>è®¿é—®é‡ï¼š<span id="visitCount">åŠ è½½ä¸­...</span></span> |
                <a href="mailto:contact@xuanmojinxue.com" style="color:#0078d4;text-decoration:none;">æ„è§åé¦ˆ</a> |
                <a href="#" onclick="showAbout()" style="color:#0078d4;text-decoration:none;">å…³äºå·¥å…·</a>
            </p>
        </div>
    </div>
    <!-- é«˜å¾·åœ°å›¾API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=f72ca59fa68ebfb555b09f8d2292b278"></script>
    <script>
        // è¿™é‡Œå†™æ‰€æœ‰JSä»£ç ï¼Œä¸è¦æœ‰ä»»ä½•HTMLæ ‡ç­¾
        // ...ä½ çš„JSé€»è¾‘...
    
        let userLocation = null;
        let currentQueryPoint = null;
        let map, marker, satelliteMode = false;
        let lastAddress = '';
        let lastCategory = '';
        let allRestaurants = []; // å­˜å‚¨æ‰€æœ‰æœç´¢åˆ°çš„é¤å…
        let customCategories = ['çƒ§çƒ¤','ç«é”…','å¿«é¤','ä¸­é¤','è¥¿é¤','éº»è¾£çƒ«','å°åƒ','å’–å•¡å…','é…’å§','é…’æ¥¼','åŒ»ç–—ç±»','å•†è¶…ç±»','æ•™è‚²æœºæ„','å…¶ä»–'];

        // åˆå§‹åŒ–é«˜å¾·åœ°å›¾
        function initMap() {
            map = new AMap.Map('map', {
                center: [121.4847, 31.2401],
                zoom: 13,
                mapStyle: 'amap://styles/normal'
            });
            map.on('click', function(e) {
                const lng = e.lnglat.getLng();
                const lat = e.lnglat.getLat();
                if (marker) { marker.setMap(null); }
                marker = new AMap.Marker({ position: [lng, lat] });
                marker.setMap(map);
                getAddressByCoord(lat, lng, function(addr){
                    document.getElementById('addressInput').value = addr;
                    lastAddress = addr;
                });
                showStatus(`å·²é€‰å®šåœ°å›¾ç‚¹ï¼šçº¬åº¦${lat.toFixed(6)}ï¼Œç»åº¦${lng.toFixed(6)}`);
                currentQueryPoint = {lat, lng};
                searchNearbyRestaurants(lat, lng);
            });
        }

        function getLocationAndRecommend() {
            if (!navigator.geolocation) {
                showStatus("æ— æ³•è·å–åœ°ç†ä½ç½®ï¼Œæµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®APIã€‚å¯æ‰‹åŠ¨è¾“å…¥åœ°æ ‡æˆ–åæ ‡ã€‚");
                return;
            }
            showStatus("æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...");
            navigator.geolocation.getCurrentPosition(
                pos => {
                    userLocation = pos.coords;
                    showStatus(`å·²è·å–ä½ç½®ï¼šçº¬åº¦${userLocation.latitude.toFixed(4)}ï¼Œç»åº¦${userLocation.longitude.toFixed(4)}`);
                    currentQueryPoint = {lat: userLocation.latitude, lng: userLocation.longitude};
                    map.setCenter([userLocation.longitude, userLocation.latitude]);
                    if (marker) { marker.setMap(null); }
                    marker = new AMap.Marker({ position: [userLocation.longitude, userLocation.latitude] });
                    marker.setMap(map);
                    getAddressByCoord(userLocation.latitude, userLocation.longitude, function(addr){
                        document.getElementById('addressInput').value = addr;
                        lastAddress = addr;
                    });
                    searchNearbyRestaurants(userLocation.latitude, userLocation.longitude);
                },
                err => {
                    showStatus("ä½ç½®è·å–å¤±è´¥ï¼Œå¯æ‰‹åŠ¨è¾“å…¥åœ°æ ‡æˆ–åæ ‡ã€‚");
                },
                { enableHighAccuracy: true, timeout: 5000 }
            );
        }

        // éšæœºæ¨èåŠŸèƒ½
        function showRandomRecommendation() {
            if (allRestaurants.length === 0) {
                showStatus('âŒ è¯·å…ˆè·å–é™„è¿‘é¤å…ä¿¡æ¯');
                return;
            }
            
            // éšæœºé€‰æ‹©ä¸€å®¶é¤å…
            const randomIndex = Math.floor(Math.random() * allRestaurants.length);
            const randomRestaurant = allRestaurants[randomIndex];
            
            // åˆ›å»ºéšæœºæ¨èçš„å¼¹çª—
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 300px;
                text-align: center;
                border: 2px solid #e74c3c;
            `;
            
            popup.innerHTML = `
                <h3 style="color: #e74c3c; margin-bottom: 15px;">ğŸ² éšæœºæ¨è</h3>
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #333;">${randomRestaurant.name}</div>
                <div style="color: #666; margin-bottom: 8px;">ç±»å‹: ${getCustomType(randomRestaurant.typecode) || 'é¤å…'}</div>
                <div style="color: #666; margin-bottom: 8px;">åœ°å€: ${randomRestaurant.address || 'æœªçŸ¥'}</div>
                <div style="color: #666; margin-bottom: 15px;">è·ç¦»: ${randomRestaurant.distance ? (randomRestaurant.distance + 'm') : 'æœªçŸ¥'}</div>
                <div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;margin-right:10px;cursor:pointer;">å…³é—­</button>
                    <button onclick="window.open('https://uri.amap.com/marker?position=${randomRestaurant.location}&name=${encodeURIComponent(randomRestaurant.name)}&src=myapp')" style="background:#28a745;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">å¯¼èˆª</button>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // åˆ›å»ºèƒŒæ™¯é®ç½©
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
            `;
            overlay.onclick = () => {
                popup.remove();
                overlay.remove();
            };
            document.body.appendChild(overlay);
            
            // 8ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (popup.parentElement) {
                    popup.remove();
                    overlay.remove();
                }
            }, 8000);
        }

        function searchNearbyRestaurants(lat, lng) {
            let radiusRaw = document.getElementById('radiusInput').value.trim();
            let radius = parseRadius(radiusRaw);
            let pageSize = 20; // é«˜å¾·APIæœ€å¤§20
            let results = [];
            const listDiv = document.getElementById('restaurantList');
            listDiv.innerHTML = '<div style="text-align:center;color:#888;">æ­£åœ¨åŠ è½½é¤å…...</div>';
            
            console.log(`æœç´¢å‚æ•°: è¾“å…¥èŒƒå›´="${radiusRaw}", è§£æåèŒƒå›´=${radius}ç±³ (${(radius/1000).toFixed(1)}å…¬é‡Œ)`);
            showStatus(`ğŸ” æ­£åœ¨æœç´¢${(radius/1000).toFixed(1)}å…¬é‡ŒèŒƒå›´å†…çš„é¤å…...`);

            // è‡ªåŠ¨å¾ªç¯è¯·æ±‚æ‰€æœ‰é¡µ
            (async function fetchAllPages() {
                let page = 1;
                let allPois = [];
                let hasMore = true;
                showStatus('æ­£åœ¨æœç´¢é¤å…...');
                
                while (hasMore && page <= 10) { // å¢åŠ åˆ°æœ€å¤š10é¡µï¼Œæ¯é¡µ20ä¸ªï¼Œæœ€å¤š200å®¶é¤å…
                    const url = `https://restapi.amap.com/v3/place/around?key=f72ca59fa68ebfb555b09f8d2292b278&location=${lng},${lat}&types=050000&radius=${Math.round(radius)}&offset=${pageSize}&page=${page}`;
                    console.log(`ç¬¬${page}é¡µè¯·æ±‚URL: ${url}`);
                    try {
                        const res = await fetch(url);
                        const data = await res.json();
                        
                        console.log(`ç¬¬${page}é¡µAPIå“åº”:`, data);
                        console.log(`APIè¿”å›çš„é¤å…æ•°é‡: ${data.pois ? data.pois.length : 0}`);
                        
                        if (data.pois && data.pois.length > 0) {
                            // ä¸å†è¿›è¡Œé¢å¤–çš„è·ç¦»è¿‡æ»¤ï¼Œå› ä¸ºAPIå·²ç»æ ¹æ®radiuså‚æ•°è¿‡æ»¤äº†
                            allPois = allPois.concat(data.pois);
                            console.log(`ç¬¬${page}é¡µï¼šè·å–åˆ°${data.pois.length}å®¶é¤å…ï¼Œæ€»è®¡${allPois.length}å®¶`);
                            
                            // å¦‚æœè¿™ä¸€é¡µçš„æ•°æ®å°‘äºpageSizeï¼Œè¯´æ˜æ²¡æœ‰æ›´å¤šæ•°æ®äº†
                            if (data.pois.length < pageSize) {
                                hasMore = false;
                            }
                            page++;
                        } else {
                            hasMore = false;
                        }
                    } catch (error) {
                        console.error('APIè¯·æ±‚å¤±è´¥:', error);
                        showStatus("é¤å…æ•°æ®è·å–å¤±è´¥ã€‚");
                        hasMore = false;
                    }
                }
                
                results = allPois;
                allRestaurants = results; // ç¡®ä¿å…¨å±€å˜é‡æ­£ç¡®èµ‹å€¼
                window._lastRestaurants = results;
                
                if (results.length === 0) {
                    showStatus(`åœ¨${(radius/1000).toFixed(1)}å…¬é‡ŒèŒƒå›´å†…æœªæ‰¾åˆ°é¤å…ï¼Œè¯·å°è¯•æ‰©å¤§æœç´¢èŒƒå›´ã€‚`);
                    listDiv.innerHTML = '<div style="text-align:center;color:#888;">æœªæ‰¾åˆ°é¤å…</div>';
                } else {
                    showRestaurants(results);
                    showStatus(`âœ… åœ¨${(radius/1000).toFixed(1)}å…¬é‡ŒèŒƒå›´å†…æ‰¾åˆ°${results.length}å®¶é¤å…ï¼Œå·²å…¨éƒ¨æ˜¾ç¤ºã€‚`);
                }
                renderPagination(1, 1);
            })();
        }

        // åœ°å€è¾“å…¥æ™ºèƒ½è”æƒ³
        document.getElementById('addressInput').addEventListener('input', function(e){
            let val = e.target.value.trim();
            if (!val) {
                document.getElementById('addressSuggest').style.display = 'none';
                return;
            }
            // é«˜å¾·è¾“å…¥æç¤ºAPI
            fetch(`https://restapi.amap.com/v3/assistant/inputtips?key=f72ca59fa68ebfb555b09f8d2292b278&keywords=${encodeURIComponent(val)}&city=`)
                .then(res=>res.json())
                .then(data=>{
                    let suggestDiv = document.getElementById('addressSuggest');
                    suggestDiv.innerHTML = '';
                    if (data.tips && data.tips.length > 0) {
                        data.tips.forEach(tip=>{
                            let item = document.createElement('div');
                            item.style = 'padding:6px;cursor:pointer;';
                            item.textContent = `${tip.name}${tip.district?(' - '+tip.district):''}`;
                            item.onclick = function(){
                                document.getElementById('addressInput').value = tip.name;
                                suggestDiv.style.display = 'none';
                                if (tip.location) {
                                    let [lng,lat] = tip.location.split(',');
                                    currentQueryPoint = {lat:parseFloat(lat),lng:parseFloat(lng)};
                                    map.setCenter([parseFloat(lng),parseFloat(lat)]);
                                    if (marker) { marker.setMap(null); }
                                    marker = new AMap.Marker({ position: [parseFloat(lng),parseFloat(lat)] });
                                    marker.setMap(map);
                                    searchNearbyRestaurants(parseFloat(lat),parseFloat(lng));
                                }
                            };
                            suggestDiv.appendChild(item);
                        });
                        suggestDiv.style.display = 'block';
                    } else {
                        suggestDiv.style.display = 'none';
                    }
                });
        });
        document.body.addEventListener('click', function(e){
            if (!e.target.closest('#addressInput')) {
                document.getElementById('addressSuggest').style.display = 'none';
            }
        });

        // åœ°å€è¾“å…¥å›è½¦æ”¯æŒåæ ‡
        document.getElementById('addressInput').addEventListener('keydown', function(e){
            if (e.key === 'Enter') {
                let val = e.target.value.trim();
                // æ”¯æŒåæ ‡è¾“å…¥
                let coordMatch = val.match(/^([0-9.]+)[,ï¼Œ ]+([0-9.]+)$/);
                if (coordMatch) {
                    let lat = parseFloat(coordMatch[1]);
                    let lng = parseFloat(coordMatch[2]);
                    currentQueryPoint = {lat, lng};
                    map.setCenter([lng, lat]);
                    if (marker) { marker.setMap(null); }
                    marker = new AMap.Marker({ position: [lng, lat] });
                    marker.setMap(map);
                    searchNearbyRestaurants(lat, lng);
                    return;
                }
                // åœ°å€ç›´æ¥æœç´¢
                fetch(`https://restapi.amap.com/v3/geocode/geo?key=f72ca59fa68ebfb555b09f8d2292b278&address=${encodeURIComponent(val)}`)
                    .then(res=>res.json())
                    .then(data=>{
                        if (data.geocodes && data.geocodes.length > 0) {
                            let geo = data.geocodes[0];
                            let [lng,lat] = geo.location.split(',');
                            currentQueryPoint = {lat:parseFloat(lat),lng:parseFloat(lng)};
                            map.setCenter([parseFloat(lng),parseFloat(lat)]);
                            if (marker) { marker.setMap(null); }
                            marker = new AMap.Marker({ position: [parseFloat(lng),parseFloat(lat)] });
                            marker.setMap(map);
                            searchNearbyRestaurants(parseFloat(lat),parseFloat(lng));
                        } else {
                            showStatus('åœ°å€æ— æ³•è¯†åˆ«ï¼Œè¯·è¾“å…¥æ›´ç²¾ç¡®çš„åœ°å€æˆ–åæ ‡');
                        }
                    });
            }
        });

        // åœ°å›¾å«æ˜Ÿ/æ ‡å‡†åˆ‡æ¢
        document.getElementById('satelliteBtn').onclick = function() {
            satelliteMode = !satelliteMode;
            map.setMapStyle(satelliteMode ? 'amap://styles/satellite' : 'amap://styles/normal');
        };

        // èŒƒå›´è¾“å…¥æ”¯æŒå•ä½è‡ªåŠ¨è¯†åˆ«
        document.getElementById('radiusInput').addEventListener('input', function(e){
            let val = e.target.value.trim();
            let meters = parseRadius(val);
            let tip = '';
            if (meters < 500) tip = 'èŒƒå›´è¾ƒå°ï¼Œå¯èƒ½æ‰¾åˆ°çš„é¤å…è¾ƒå°‘';
            else if (meters > 20000) tip = 'èŒƒå›´è¾ƒå¤§ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´æœç´¢';
            else tip = `æœç´¢åŠå¾„: ${(meters/1000).toFixed(1)}å…¬é‡Œï¼Œçº¦è¦†ç›–${(Math.PI*meters*meters/1000000).toFixed(2)}å¹³æ–¹å…¬é‡Œ`;
            document.getElementById('radiusTip').textContent = tip;
        });
        function parseRadius(val) {
            // å…ˆæ£€æŸ¥æ˜¯å¦åŒ…å«å…¬é‡Œå•ä½
            let isKilometer = /å…¬é‡Œ|km/i.test(val);
            // ç„¶åç§»é™¤æ‰€æœ‰å•ä½å­—ç¬¦
            val = val.replace(/ç±³|m|å…¬é‡Œ|km/gi,'');
            let num = parseFloat(val);
            if (isNaN(num)) num = 2; // é»˜è®¤2å…¬é‡Œ
            // å¦‚æœæ˜¯å…¬é‡Œå•ä½ï¼Œè½¬æ¢ä¸ºç±³
            if (isKilometer) {
                num *= 1000;
            } else if (num < 50) {
                // å¦‚æœæ•°å­—å¤ªå°ä¸”æ²¡æœ‰æ˜ç¡®å•ä½ï¼Œå‡è®¾æ˜¯å…¬é‡Œ
                num *= 1000;
            }
            // é™åˆ¶èŒƒå›´åœ¨100ç±³åˆ°50å…¬é‡Œä¹‹é—´
            return Math.max(100, Math.min(num, 50000));
        }

        // é€†åœ°å€è§£æ
        function getAddressByCoord(lat, lng, cb) {
            fetch(`https://restapi.amap.com/v3/geocode/regeo?key=f72ca59fa68ebfb555b09f8d2292b278&location=${lng},${lat}`)
                .then(res=>res.json())
                .then(data=>{
                    if (data.regeocode && data.regeocode.formatted_address) {
                        cb(data.regeocode.formatted_address);
                    } else {
                        cb('');
                    }
                });
        }

        // åˆ†ç±»ç­›é€‰åŒºæ¸²æŸ“
        function renderCategoryFilter(typeMap) {
            const filterDiv = document.getElementById('categoryFilter');
            filterDiv.innerHTML = '';
            let types = Object.keys(typeMap);
            if (types.length > 1) {
                let html = 'ç­›é€‰åˆ†ç±»ï¼š<select id="categorySel" style="padding:6px 12px;border-radius:6px;border:1px solid #ccc;"><option value="">å…¨éƒ¨</option>';
                types.forEach(t=>{ html += `<option value="${t}">${t}ï¼ˆ${typeMap[t].length}å®¶ï¼‰</option>`; });
                html += '</select>';
                filterDiv.innerHTML = html;
                document.getElementById('categorySel').onchange = function() {
                    lastCategory = this.value;
                    showRestaurants(window._lastRestaurants);
                };
            }
        }

        // æ”¯æŒè‡ªå®šä¹‰åˆ†ç±»æ¨¡æ¿
        function getCustomType(rawType) {
            // è¯¦ç»†çš„åˆ†ç±»æ˜ å°„è¡¨
            const typeMap = {
                '050000': 'é¤é¥®æœåŠ¡',
                '050100': 'ä¸­é¤å…', '050101': 'å·èœ', '050102': 'ç²¤èœ', '050103': 'é²èœ', '050104': 'æ¹˜èœ', 
                '050105': 'æµ™èœ', '050106': 'è‹èœ', '050107': 'é—½èœ', '050108': 'å¾½èœ', '050109': 'äº¬èœ',
                '050110': 'ä¸œåŒ—èœ', '050111': 'è¥¿åŒ—èœ', '050112': 'äº‘å—èœ', '050113': 'è´µå·èœ', '050114': 'æ±Ÿè¥¿èœ',
                '050115': 'å±±è¥¿èœ', '050116': 'æ²³å—èœ', '050117': 'æ²³åŒ—èœ', '050118': 'æ–°ç–†èœ', '050119': 'æ¹–åŒ—èœ',
                '050120': 'å¤©æ´¥èœ', '050121': 'ä¸Šæµ·èœ', '050199': 'å…¶ä»–ä¸­é¤å…',
                '050200': 'å¤–å›½é¤å…', '050201': 'æ³•å›½èœ', '050202': 'æ„å¤§åˆ©èœ', '050203': 'å¾·å›½èœ', '050204': 'ä¿„å›½èœ',
                '050205': 'å°åº¦èœ', '050206': 'æ—¥æœ¬æ–™ç†', '050207': 'éŸ©å›½æ–™ç†', '050208': 'æ³°å›½èœ', '050209': 'è¶Šå—èœ',
                '050210': 'ç¾å¼å¿«é¤', '050211': 'å¢¨è¥¿å“¥èœ', '050212': 'å·´è¥¿èœ', '050213': 'åœŸè€³å…¶èœ', 
                '050214': 'é˜¿æ‹‰ä¼¯èœ', '050215': 'å¸Œè…Šèœ', '050216': 'è¥¿ç­ç‰™èœ', '050217': 'è‹±å›½èœ', 
                '050218': 'è‘¡è„ç‰™èœ', '050219': 'æ¾³æ´²èœ', '050299': 'å…¶ä»–å¤–å›½èœ',
                '050300': 'å¿«é¤å…', '050301': 'è‚¯å¾·åŸº', '050302': 'éº¦å½“åŠ³', '050303': 'å¿…èƒœå®¢', 
                '050304': 'å¾·å…‹å£«', '050305': 'å‰é‡å®¶', '050306': 'çœŸåŠŸå¤«', '050307': 'æ°¸å’Œå¤§ç‹', 
                '050308': 'å¤§å®¶ä¹', '050309': 'é£Ÿå…¶å®¶', '050310': 'é¢ç‚¹ç‹', '050311': 'æ±‰å ¡ç‹',
                '050399': 'å…¶ä»–å¿«é¤',
                '050400': 'ä¼‘é—²é¤é¥®', '050401': 'èŒ¶é¦†', '050402': 'å’–å•¡å…', '050403': 'é…’å§', 
                '050404': 'KTV', '050405': 'ç”œå“åº—', '050406': 'å†·é¥®åº—', '050407': 'é¢åŒ…åº—',
                '050408': 'è›‹ç³•åº—', '050409': 'æœæ±åº—', '050410': 'å¥¶èŒ¶åº—', '050499': 'å…¶ä»–ä¼‘é—²é¤é¥®',
                '050500': 'åœ°æ–¹ç‰¹è‰²é¤å…', '050501': 'é‡åº†ç«é”…', '050502': 'å››å·ç«é”…', '050503': 'æ¶®ç¾Šè‚‰',
                '050504': 'çƒ§çƒ¤åº—', '050505': 'æµ·é²œ', '050506': 'å°åƒå¿«é¤åº—', '050507': 'ä¸œåŒ—é¥ºå­é¦†',
                '050508': 'å…°å·æ‹‰é¢', '050509': 'æ²™å¿å°åƒ', '050510': 'é»„ç„–é¸¡ç±³é¥­', '050511': 'é‡åº†å°é¢',
                '050512': 'éº»è¾£çƒ«', '050513': 'å…³ä¸œç…®', '050514': 'ç…é¥¼æœå­', '050515': 'è‚‰å¤¹é¦',
                '050516': 'é©´è‚‰ç«çƒ§', '050517': 'è‡­è±†è…', '050518': 'ç« é±¼çƒ§', '050519': 'é“æ¿çƒ§',
                '050520': 'éŸ©å¼çƒ¤è‚‰', '050521': 'æ—¥å¼çƒ¤è‚‰', '050522': 'è‡ªåŠ©é¤', '050523': 'å†œå®¶ä¹',
                '050599': 'å…¶ä»–ç‰¹è‰²é¤å…'
            };
            
            // å…ˆæ£€æŸ¥ç²¾ç¡®åŒ¹é…
            if (typeMap[rawType]) {
                return typeMap[rawType];
            }
            
            // ç„¶åæ£€æŸ¥è‡ªå®šä¹‰åˆ†ç±»
            for (let i=0;i<customCategories.length;i++) {
                if (rawType && rawType.includes(customCategories[i])) return customCategories[i];
            }
            
            // æœ€åè¿”å›åŸå§‹ç±»å‹æˆ–é»˜è®¤å€¼
            return rawType || 'å…¶ä»–';
        }

        function showRestaurants(restaurants) {
            const listDiv = document.getElementById('restaurantList');
            listDiv.innerHTML = '';
            if (!restaurants || restaurants.length === 0) return;
            
            let typeMap = {};
            restaurants.forEach(r => {
                let type = getCustomType(r.type||'');
                if (!typeMap[type]) typeMap[type] = [];
                typeMap[type].push(r);
            });
            
            renderCategoryFilter(typeMap);
            Object.keys(typeMap).forEach(type => {
                if (lastCategory && type !== lastCategory) return;
                listDiv.innerHTML += `<div style='font-weight:bold;font-size:16px;color:#0078d4;margin:18px 0 8px 0;'>${type}ï¼ˆ${typeMap[type].length}å®¶ï¼‰</div>`;
                typeMap[type].forEach(r => {
                    let html = `<div class="restaurant">
                        <div class="restaurant-title">${r.name}</div>
                        <div class="restaurant-info">ç±»å‹ï¼š${r.type || 'é¤å…'} | è·ç¦»ï¼š${r.distance ? (r.distance/1000).toFixed(2) : '-'}km</div>
                        <div class="restaurant-info">åœ°å€ï¼š${r.address}</div>
                    </div>`;
                    listDiv.innerHTML += html;
                });
            });
        }

        // åˆ‡æ¢åˆ†ç±»æ–¹å¼æ—¶è‡ªåŠ¨åˆ·æ–°
        // åªä¿ç•™ä¸€ä»½äº‹ä»¶ç»‘å®šå’Œåˆå§‹åŒ–æµç¨‹
        window.onload = function() {
            initMap();
            getLocationAndRecommend();
            // åˆ·æ–°æŒ‰é’®
            document.getElementById('refreshBtn').onclick = function() {
                lastCategory = '';
                if (currentQueryPoint) {
                    searchNearbyRestaurants(currentQueryPoint.lat, currentQueryPoint.lng);
                } else if (userLocation) {
                    searchNearbyRestaurants(userLocation.latitude, userLocation.longitude);
                } else {
                    getLocationAndRecommend();
                }
            };
            
            // éšæœºæ¨èæŒ‰é’®
            document.getElementById('randomBtn').onclick = function() {
                showRandomRecommendation();
            };
            
            // åˆå§‹åŒ–è®¿é—®ç»Ÿè®¡
            initVisitCounter();
        };
        
        // æ˜¾ç¤ºå…³äºä¿¡æ¯
        function showAbout() {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                text-align: left;
                border: 2px solid #0078d4;
            `;
            
            popup.innerHTML = `
                <h3 style="color: #0078d4; margin-bottom: 20px; text-align: center;">ğŸ½ï¸ å…³äºéšæœºé€‰é¥­åº—å·¥å…·</h3>
                <div style="line-height: 1.6; color: #333; margin-bottom: 20px;">
                    <p><strong>åŠŸèƒ½ç‰¹è‰²ï¼š</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>ğŸ¯ ç²¾å‡†å®šä½ï¼šè‡ªåŠ¨è·å–æ‚¨çš„ä½ç½®</li>
                        <li>ğŸ—ºï¸ åœ°å›¾é€‰ç‚¹ï¼šç‚¹å‡»åœ°å›¾ä»»æ„ä½ç½®æœç´¢</li>
                        <li>ğŸ“ è‡ªå®šä¹‰èŒƒå›´ï¼šæ”¯æŒç±³/å…¬é‡Œå•ä½</li>
                        <li>ğŸ² éšæœºæ¨èï¼šå‘Šåˆ«é€‰æ‹©å›°éš¾ç—‡</li>
                        <li>ğŸ·ï¸ åˆ†ç±»ç­›é€‰ï¼šæŒ‰é¤å…ç±»å‹ç­›é€‰</li>
                        <li>ğŸ§­ ä¸€é”®å¯¼èˆªï¼šç›´è¾¾ç›®æ ‡é¤å…</li>
                    </ul>
                    <p><strong>æ•°æ®æ¥æºï¼š</strong>é«˜å¾·åœ°å›¾API</p>
                    <p><strong>å¼€å‘è€…ï¼š</strong>ç„å¢¨é‡‘å­¦å›¢é˜Ÿ</p>
                    <p><strong>ç‰ˆæœ¬ï¼š</strong>v2.0 (2025.8.5)</p>
                </div>
                <div style="text-align: center;">
                    <button onclick="this.parentElement.parentElement.remove(); document.querySelector('.about-overlay').remove();" style="background:#0078d4;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">çŸ¥é“äº†</button>
                </div>
            `;
            
            // åˆ›å»ºèƒŒæ™¯é®ç½©
            const overlay = document.createElement('div');
            overlay.className = 'about-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
            `;
            overlay.onclick = () => {
                popup.remove();
                overlay.remove();
            };
            
            document.body.appendChild(overlay);
            document.body.appendChild(popup);
        }
        
        // ç®€å•çš„è®¿é—®ç»Ÿè®¡
        function initVisitCounter() {
            try {
                let visitCount = localStorage.getItem('visitCount') || 0;
                visitCount = parseInt(visitCount) + 1;
                localStorage.setItem('visitCount', visitCount);
                document.getElementById('visitCount').textContent = visitCount;
            } catch (e) {
                document.getElementById('visitCount').textContent = 'å·²åŠ è½½';
            }
        }
        function showStatus(msg) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = msg;
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®ä¸åŒçš„æ ·å¼
            statusEl.className = '';
            if (msg.includes('âŒ') || msg.includes('å¤±è´¥') || msg.includes('é”™è¯¯')) {
                statusEl.style.color = '#e74c3c';
                statusEl.style.fontWeight = 'bold';
            } else if (msg.includes('âœ…') || msg.includes('æˆåŠŸ') || msg.includes('å®Œæˆ')) {
                statusEl.style.color = '#27ae60';
                statusEl.style.fontWeight = 'bold';
            } else if (msg.includes('ğŸ”') || msg.includes('æ­£åœ¨')) {
                statusEl.style.color = '#3498db';
                statusEl.style.fontWeight = 'normal';
            } else {
                statusEl.style.color = '#666';
                statusEl.style.fontWeight = 'normal';
            }
        }
        function renderPagination(page, totalPage) {
            // ...å¯æŒ‰éœ€è¡¥å……åˆ†é¡µé€»è¾‘...
        }
    </script>
</body>
</html>
